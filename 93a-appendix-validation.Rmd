# Validation

```{r, echo=FALSE, eval=TRUE, collapse=TRUE, include=FALSE}
library(dplyr)
library(ggplot2)
library(plotly)
library(magrittr)
library(LTabundR)
library(swfscDAS)

load('whiceas_settings.RData')

rerun_from_scratch <- FALSE
# If you want to confirm the package works, change to TRUE.
# If you already know it does, change to FALSE so that knitting is quick
# (it will use saved R objects instead of producing them anew)
```

```{r, echo=FALSE, eval=TRUE, collapse=TRUE}
load('whiceas_cruz.RData')
```

To validate these `LTabundR` functions, we can compare its output to that of `ABUND9`, written by Jay Barlow (NOAA Fisheries). First, we bring in the `ABUND9` output files for the same `DAS` data: 

```{r, echo=TRUE, eval=TRUE, collapse=TRUE}
# Local paths to these files
SIGHTS <- read.csv('data/SIGHTS.csv')
EFFORT <- read.csv('data/EFFORT.csv')
```

You may download these files here: [`SIGHTS.csv`](https://raw.githubusercontent.com/emk-noaa/LTAvignette/main/data/SIGHTS.csv) and [`EFFORT.csv`](https://raw.githubusercontent.com/emk-noaa/LTAvignette/main/data/EFFORT.csv). 


### Sightings {-}  

Pivot and format the `ABUND` `SIGHTS` data...

```{r, echo=TRUE, eval=TRUE, message=FALSE, collapse=TRUE}
abund <-
  SIGHTS %>%
  tidyr::pivot_longer(cols = 31:101,
                      names_to = 'species',
                      values_to = 'best') %>%
  filter(best > 0) %>%
  mutate(Region = gsub(' ','',Region)) %>%
  mutate(DateTime = paste0(Yr,'-',Mo,'-',Da,' ',Hr,':',Min))
```

...then summarize counts of species within each cruise: 

```{r, echo=TRUE, eval=TRUE, message=FALSE, collapse=TRUE}
abund_summ <-
  abund %>%
  group_by(cruise = CruzNo, species) %>%
  summarize(ntot_abund = n(),
            nsys_abund = length(which(! Region %in% c('NONE', 
                                                      'Off-Transect') & 
                                        EffortSeg > 0))) %>%
  mutate(species = gsub('SP','',species))
```

Then do the same for `LTabundR` output: 

```{r, echo=TRUE, eval=TRUE, message=FALSE, collapse=TRUE}
ltabundr <- 
  cruz$cohorts$all$sightings %>% 
  # Filter out species that ABUND ignored based on its INP file
  filter(!species %in% c('CU', 'PU'))
  
ltabundr_summ <-
  ltabundr %>%
  filter(OnEffort == TRUE) %>% 
  group_by(cruise = Cruise, species) %>%
  summarize(ntot_ltabundr = n(),
            nsys_ltabundr = length(which(included == TRUE & 
                                           EffType %in% c('S','F'))))
```

Now join these two datasets by cruise and species code: 

```{r, echo=TRUE, eval=TRUE, message=FALSE, collapse=TRUE}
mr <- full_join(abund_summ, ltabundr_summ, by=c('cruise', 'species'))

mr %>% head
```

Compare the total On-Effort sightings in both outputs: 

```{r, echo=TRUE, eval=TRUE, message=FALSE, collapse=TRUE}
mr$ntot_abund %>% sum(na.rm=TRUE)
mr$ntot_ltabundr %>% sum(na.rm=TRUE)
```

Compare total sightings valid for use in density estimation (`EffType` `"S"` or `"F"` only, as well as other criteria such as Bft 0 - 6): 

```{r, echo=TRUE, eval=TRUE, message=FALSE, collapse=TRUE}
mr$nsys_abund %>% sum(na.rm=TRUE)
mr$nsys_ltabundr %>% sum(na.rm=TRUE)
```

Let's find the rows with discrepancies in sighting counts: 

```{r, echo=TRUE, eval=TRUE, message=FALSE, collapse=TRUE}
bads <- which(mr$nsys_abund != mr$nsys_ltabundr | 
              mr$ntot_abund != mr$ntot_ltabundr | 
              is.na(mr$ntot_abund) | 
              is.na(mr$ntot_ltabundr) | 
              is.na(mr$nsys_abund) | 
              is.na(mr$nsys_ltabundr))
bads %>% length
```

Let's look at those rows in the joined dataframe: 

```{r, echo=TRUE, eval=TRUE, message=FALSE, collapse=TRUE}
mr[bads, ]
```

To investigate these 5 discrepancies, we will write a helper function that returns sightings details from both outputs for a given cruise-species: 

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
sight_compare <- function(abund, ltabundr, cruise, spp){
  message('ABUND:')
  abund %>%
    filter(CruzNo == cruise, species == paste0('SP',spp)) %>%
    select(5, 34, 26, 29, 33, 3) %>%
    mutate(use_sit = EffortSeg != 0) %>%
    select(-EffortSeg) %>%
    arrange(desc(use_sit)) %>%
    print

  abund %>%
    filter(CruzNo == 1631) %>% pull(species) %>% table
  
  
  message('\nLTabundR:')
  ltabundr %>%
    filter(Cruise == cruise, species == spp) %>%
    select(6, 2, 13, 74, 70, 5, 9, 40, 87) %>%
    rename(use_sit = included, use_effort = use) %>%
    arrange(desc(use_effort)) %>%
    tibble %>% print
}
```

#### Discrepancies {-} 

##### Cruise 1203, Species 015 {-} 

In this case, `LTabundR` has a non-systematic sighting that `ABUND` has ignored. 

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
sight_compare(abund, ltabundr, 1203, '015')
```

Looking at the sighting details from `LTabundR` ...

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
(ltabundr %>% filter(Cruise == 1203, species == '015'))[1,]
```

According to `ABUND`, this sighting is not mixed-species, but `LTabundR` says it is. Looking at the raw `DAS`...

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
das_file <- 'data/surveys/CenPac1986-2020_Final_alb.das'
das <- das_readtext(das_file)
i <- which(substr(das$das, 6, 18) == '131944 051312')
das$das[i]
```

We see that this was a sighting of false killer whales during which species `015` was picked up during photo-ID. In the absence of a percent composition estimate for this sighting, it was ignored by `ABUND`.  


##### Cruise 1203, Species 049 {-} 

In this case, `LTabundR` has a non-systematic sighting that `ABUND` has ignored. 

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
sight_compare(abund, ltabundr, 1203, '049')
```

Looking at the sighting details from `LTabundR` ...

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
(ltabundr %>% filter(Cruise == 1203, species == '049'))[2,]
```

This is a sighting of a single Ziphiid whale. It appears to be within the geostratum: 

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
cruzi <- filter_cruz(cruz, spp='049', years = 1988)
map_cruz(cruzi)
```

Loooking at the raw `DAS` data ...

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
i <- which(substr(das$das, 6, 18) == '105409 050712')
das$das[(i[1] - 10):(i[1] + 3)]
```

It is not clear why `ABUND` did not include this sighting as non-systematic. Perhaps the `ABUND` geostratum calculations placed this sighting outside of the study area.  

##### Cruise 1165, Species 047 {-} 

In this case, `LTabundR` has a *systematic* sighting of a pygmy sperm whale that `ABUND` has ignored. 

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
sight_compare(abund, ltabundr, 1165, '047')
(ltabundr %>% filter(Cruise == 1165, species == '047'))[1,]
```

To investigate this sighting, we can filter our `cruz` object and take a look at a map of this sighting: 

```{r, echo=TRUE, eval=FALSE, message=FALSE, collapse=TRUE}
cruzi <- filter_cruz(cruz, spp='047', years = 2012)
map_cruz(cruzi)
```

Using that map we see that this sighting occurred *just inside* of the `OtherCNP` geostratum. It is likely that the point-in-polygon subroutines inside `ABUND9` decided that this sighting was out of the study area, and therefore excluded it. The subroutines used by `LTabundR`, which are based in the `R` package `sf`, should not be wrong in this case. 

##### Cruise 1621-073 {-} 

In this case, both `LTabundR` and `ABUND` logged the same total number of sightings, but `ABUND` determined that that one was not valid for for density estimation, whereas `LTabundR` determined that two of them were not valid. 

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
sight_compare(abund, ltabundr, 1621, '073')
```

The discrepancy is in the November 8, 2002 sighting at 14:19:04. Looking at the sighting details from `LTabundR`...

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
(ltabundr %>% filter(Cruise == 1621, species == '073'))[1,]
```

`LTabundR` was correct to exclude this sighting because the bearing was past the beam (93 degrees). The bearing of 93 is also given in the raw `DAS` data...  

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
das_file <- 'data/surveys/CenPac1986-2020_Final_alb.das'
das <- das_readtext(das_file)
i <- which(substr(das$das, 6, 18) == '141904 110802')
das$das[i]
```

... so it is not clear why `ABUND` did not exclude this sighting as invalid as well. It may be that `ABUND` was not expecting bearings above 90 degrees in the on-effort data. 


##### Cruise 1631, Species 003 {-} 

In this case, there was a non-systematic sighting of species 003 that was found by `LTabundR` but not by `ABUND`. 

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
sight_compare(abund, ltabundr, 1631, '003')
(ltabundr %>% filter(Cruise == 1631, species == '003'))
```

The map indicates that this is not a geostratum boundary issue: 

```{r, echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE, collapse=TRUE}
cruzi <- filter_cruz(cruz, spp='003', years = 2006)
map_cruz(cruzi)
```

Looking at the raw `DAS` data ...

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
das$das[405190:405220]
```

It appears that this was a multi-species sighting, but no species percentages were provided. In the absence of a percent composition estimate for this sighting, it was ignored by `ABUND`. 


### Group sizes {-}   

```{r, echo=TRUE, eval=TRUE, message=TRUE, collapse=TRUE}
# Format ABUND
abund <- 
  SIGHTS %>% 
  tidyr::pivot_longer(cols = 31:101,
                      names_to = 'species',
                      values_to = 'best') %>%
  mutate(Region = gsub(' ','',Region)) %>%
  filter(best > 0,
         ! Region %in% c('NONE', 'Off-Transect'),
         EffortSeg > 0) %>% 
  select(Cruise = CruzNo, TotSS, LnTotSS, species, best) %>% 
  mutate(Software='ABUND9')

# Format LTabundR
ltabundr <- 
  cruz$cohorts$all$sightings %>% 
  filter(OnEffort == TRUE, 
         included == TRUE, 
         EffType %in% c('S', 'F')) %>% 
  select(Cruise, TotSS = ss_tot, LnTotSS = lnsstot, species, best) %>% 
  mutate(Software='LTabundR')

# Combine the datasets
ss <- rbind(abund, ltabundr)

# Plot the datasets
ggplot(ss,
       aes(x=best, 
           y=factor(Cruise), 
           col=Software, 
           pch=Software)) + 
      geom_point(position=ggstance::position_dodgev(height=0.5),
                 alpha=.6) +
      scale_x_continuous(trans='log', breaks=c(1,2, 5,10,25,50,100,500,1000,2500,5000)) +
      xlab('log Estimated School Size') +
      ylab('Cruise') + 
  theme_light()
```

### Effort {-} 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, collapse=TRUE}
# Format ABUND
abund <- 
  EFFORT %>% 
  mutate(Region = gsub(' ','',Region)) %>%
  mutate(dt = paste0(Yr,
                     stringr::str_pad(Mo, width=2, pad='0', side='left'),
                     stringr::str_pad(Da, width=2, pad='0', side='left'))) %>% 
  filter(! Region %in% c('NONE', 'Off-Transect'),
         EffortSeg > 0) %>% 
  select(Cruise = CruzNo, Date = dt, km = length) %>% 
  mutate(software = 'ABUND9')
  
# Format LTabundR
ltabundr <- 
  cruz$cohorts$all$segments %>% 
  mutate(dt = gsub('-','',substr(DateTime1, 1,10))) %>% 
  filter(OnEffort == TRUE, 
         use == TRUE, 
         EffType %in% c('S', 'F')) %>% 
  select(Cruise, Date = dt, km = dist) %>% 
  mutate(software = 'LTabundR')
  
# Join the datasets
eff <- 
  rbind(abund, ltabundr) %>% 
  group_by(Cruise) %>% 
  mutate(km = round(km)) %>% 
  summarize(km_abund = sum(km[software == 'ABUND9']),
            km_ltabundr = sum(km[software == 'LTabundR']))

# Plot
p <- 
  ggplot(eff, aes(x = km_abund, y = km_ltabundr, col=factor(Cruise))) +
  geom_abline(slope=1, intercept=0, lty=3) + 
  geom_point(alpha=.6) + 
  ylab('LTabundR') + xlab('ABUND9') + 
  scale_x_continuous(breaks = seq(0, 15000, by=2500)) + 
  scale_y_continuous(breaks = seq(0, 15000, by=2500)) + 
  labs(title='Systematic effort per cruise', col='Cruise') + 
  theme_light()

# Make it interactive
ggplotly(p)
```

