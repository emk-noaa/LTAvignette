# (PART) Case studies {-}

# WHICEAS {#whiceas}

Here we demonstrate code that reproduces the Bradford et al. (2022) WHICEAS report (*In press*) within the new `LTabundR` framework. This study estimates cetacean abundance for Hawaiian WHICEAS study area for 2017 and 2020. Here we use survey data from 1986 to 2020 to estimate *Relative g(0)* and detection functions. Currently, coefficients of variation (CV) of density and abundance are estimated using only 100 bootstrap iterations (the publication uses 1,000) to reduce processing time.  

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, include=TRUE, warning=FALSE, message=FALSE}
library(dplyr)
library(LTabundR)
```

```{r, echo=FALSE, eval=TRUE, collapse=TRUE, include=TRUE, warning=FALSE, message=FALSE}
rerun_from_scratch <- FALSE
# If you want to confirm the package works, change to TRUE.
# If you already know it does, change to FALSE so that knitting is quick
# (it will use saved R objects instead of producing them anew)
```

## Data processing {-}  

### Settings {-}  

#### Survey-wide settings {-}

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
data(species_codes)
data(ships)
data(group_size_coefficients)

survey <- load_survey_settings(
  out_handling = 'remove',
  max_row_interval = Inf,
  segment_method = "equallength",
  segment_target_km = 150,
  segment_max_interval = 24,
  segment_remainder_handling = c("segment"),
  ship_list = ships,
  species_codes = species_codes,
  group_size_coefficients = group_size_coefficients,
  smear_angles = FALSE
)
```

#### Geostrata {-}  

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
data(strata_cnp)
```

#### Cohort-specific settings {-} 

##### Cohort 1: all species {-} 

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
all_species <- load_cohort_settings(
  id = "all", # *
  species = NULL, 
  strata = c('WHICEAS', 'HI_EEZ', 'OtherCNP'), # *
  probable_species = FALSE,
  sighting_method = 0,
  cue_range = 0:7,
  school_size_range = c(0, 10000),
  school_size_calibrate = TRUE,
  calibration_floor = 0,
  use_low_if_na = TRUE,
  io_sightings = 0,
  geometric_mean_group = TRUE,
  truncation_km = 7.5, # *
  beaufort_range = 0:6,
  abeam_sightings = TRUE,
  strata_overlap_handling = c("smallest"),
  distance_types = c('S','F','N'),
  distance_modes = c('P','C'),
  distance_on_off = TRUE
)
```

##### Cohort 2: bottlenose dolphins {-} 

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
bottlenose <- load_cohort_settings(
  id = "bottlenose",
  species = c('015', '018', '021', '032'),
  strata = c('WHICEAS', 'HI_EEZ', 'OtherCNP',
             'Bottlenose_BI', 'Bottlenose_OUFI', 'Bottlenose_KaNi'),
  truncation_km = 7.5)
```

##### Cohort 3: pantropical spotted dolphins {-} 

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
spotted <- load_cohort_settings(
  id = "spotted",
  species = '002',
  strata = c('WHICEAS', 'HI_EEZ', 'OtherCNP',
             'Spotted_OU','Spotted_FI','Spotted_BI'),
  truncation_km = 7.5)
```

### Process {-}  

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
settings <- load_settings(strata = strata_cnp,
                          survey = survey,
                          cohorts = list(all_species,
                                         bottlenose,
                                         spotted))

cruz <- 
  process_surveys(das_file = 'data/surveys/CenPac1986-2020_Final_alb.das',
                  settings = settings) 

save(cruz, file='whiceas/whiceas_cruz.RData')
```

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
load('whiceas/whiceas_cruz.RData')
```

## Data exploration {-}  

### Processed data structure {-}  

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
cruz_structure(cruz)
```

### Map of sightings {-}  

For the entire `cruz` object:  

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE, fig.height=7, fig.width=7}
map_cruz(cruz, sightings_color = 'firebrick')
```

For just the surveys of interest:  

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE, fig.height=7, fig.width=7}
# Filter
cruz1720 <- filter_cruz(cruz, 
                        years = c(2017, 2020), 
                        regions = 'WHICEAS',
                        eff_types = 'S',
                        bft_range = 0:6)

# Map, including survey tracks
map_cruz(cruz1720,
         sightings_color = 'firebrick', 
         effort_show = TRUE, 
         effort_resolution = 3,
         effort_weight = 4,
         effort_opacity = .4)
```

### Interactive dashboard {-}  

Use this to determine truncation distances.  Note them in your `lta()` code below: 

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE}
cruz_explorer(cruz)
```

## Rg0 {-}  

We can use the built-in dataset, `data(g0_results)`, which has Beaufort-specific *Relative g(0)* estimates for most species based on 1986-2020 surveys.  

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
data("g0_results")
Rg0 <- g0_results
```

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE, fig.width=7, fig.height=9}
# Plot the results: 
g0_plot(Rg0, panes = 3)
```

## Density & abundance {-}  

First we can define common values that will be constant across all estimates we produce: 

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
bootstraps <- 20
years <- 1986:2020
fit_regions <- NULL
fit_not_regions <- NULL
toplot = TRUE
verbose = TRUE
results_path <- 'whiceas/lta/'

df_settings <-
  list(covariates = c('bft','lnsstot','cruise','year','ship','species'),
       covariates_factor = c(FALSE, FALSE, TRUE, TRUE, TRUE, TRUE),
       covariates_levels = 2,
       covariates_n_per_level = 10,
       simplify_cue = TRUE,
       simplify_bino = TRUE,
       detection_function_base = 'hn',
       base_model = '~1',
       delta_aic = 2)
```

For most species, we want to estimate density/abundance for the same set of year-region scenarios. To reduce code redundancy, as well as the risk of typing errors (and our work!), we can use the `LTabundR` function `lta_estimates()` to economize how we prepare our `estimates` input.  

For most species, these are the year-region scenarios for which we want estimates:  

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
scenarios <- list(list(years = 2017,
                       regions = 'WHICEAS'),
                  list(years = 2020, 
                       regions = 'WHICEAS'))
```

The `lta_estimates()` function will generate a custom function that makes it easy to create a set of `estimates` sub-lists for each species of interest:  

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
estimator <- lta_estimates(scenarios)
```

That result, `estimator`, is actually a function. Here's an example of how this function will work, using the first species pool as an example: 

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
estimates <-
  c(estimator(spp = '013', title = "Striped dolphin"),
    estimator(spp = '026', title = "Fraser's dolphin", alt_g0_spp = '013'),
    estimator(spp = '031', title = "Melon-headed whale", alt_g0_spp = '013'))

estimates  
```

The output of `estimator()` is a list of sub-lists specifying a set of density/abundance estimates you want to produce based on the detection function for a single species pool.  

Here is the full code for producing those estimates for all species from Bradford et al. (2021):  

### Multi-species pool 1 {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# Striped dolphin (013), Fraser's dolphin (026), Melon-headed whale (031)

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('013', '026', '031'),
         pool = 'Multi-species pool 1',
         cohort = 'all',
         truncation_distance = 5,
         other_species = 'remove',
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  estimates <-
    c(estimator(spp = '013', title = "Striped dolphin"),
      estimator(spp = '026', title = "Fraser's dolphin", alt_g0_spp = '013'),
      estimator(spp = '031', title = "Melon-headed whale", alt_g0_spp = '013'))

  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Multi-species pool 2 {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# Rough-toothed dolphin (15), Common bottlenose dolphin (18), Risso's (21),
# Pygmy killer whale (32)

# Notes
# Bottlenose abundance is estimated in a separate cohort, but included here for DF fitting

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('015', '018', '021', '032'),
         pool = 'Multi-species pool 2',
         cohort = 'all',
         truncation_distance = 5,
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  estimates <-
      c(estimator(spp = '015', title = "Rough-toothed dolphin"),
        estimator(spp = '021', title = "Risso's dolphin"),
        estimator(spp = '032', title = "Pygmy killer whale"))

  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Multi-species pool 3 {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# Short-finned pilot whale (036), Longman's beaked whale (065)

# No Rg(0) available for Longman's -- will use SF pilot whale instead to estimate its weighted g0

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('036', '065'),
         pool = 'Multi-species pool 3',
         cohort = 'all',
         truncation_distance = 5,
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  estimates <-
    c(estimator(spp = '036', title = "Short-finned pilot whale"),
      estimator(spp = '065', title = "Longman's beaked whale", 
                alt_g0_spp = '036'))

  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Multi-species pool 4 {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# Killer whale (37), sperm whale (46)

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('037', '046'),
         pool = 'Multi-species pool 4',
         cohort = 'all',
         truncation_distance = 5.5,
         other_species = 'remove',
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  estimates <-
      c(estimator(spp = '037', title = "Killer whale"),
        estimator(spp = '046', title = "Sperm whale"))

  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Multi-species pool 5 {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# Pygmy sperm whale (47), dwarf sperm whale (48), UNID Kogia (80),
# Blainville's beaked whale (59), Cuvier's beaked whale (61),
# UNID Mesoplodon (51), UNID beaked whale (49), Minke whale (71)

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('047', '048', '080', '059', '061', '051', '049', '071'),
         pool = 'Multi-species pool 5',
         cohort = 'all',
         truncation_distance = 4.5,
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  estimates <-
      c(estimator(spp = '047', title = "Pygmy sperm whale"),
        estimator(spp = '048', title = "Dwarf sperm whale"),
        estimator(spp = '080', title = "Unidentified Kogia"),
        estimator(spp = '059', title = "Blainville's beaked whale"),
        estimator(spp = '061', title = "Curvier's beaked whale"),
        estimator(spp = '051', title = "Unidentified Mesoplodon"),
        estimator(spp = '049', title = "Unidentified beaked whale"),
        estimator(spp = '071', title = "Minke whale"))

  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Multi-species pool 6 {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# Bryde's whale (72), Sei whale (73), Fin whale (74), Blue whale (75),
# Sei/Bryde's (99), Fin/Sei/Bryde's (72, 73, 74, 99)

# Bryde's, Sei's, and Sei/Bryde's all use same Rg0 (title = "Sei/Bryde's")
# Sei/Bryde's/Fin use an average of Fin and Sei/Bryde's.

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('072', '073', '074','075','099'),
         pool = 'Multi-species pool 6',
         cohort = 'all',
         truncation_distance = 5.0,
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
   estimates <-
      c(estimator(spp = '072', title = "Bryde's whale"),
        estimator(spp = '073', title = "Sei whale"),
        estimator(spp = '074', title = "Fin whale"),
        estimator(spp = '075', title = "Blue whale"),
        estimator(spp = '099', title = "Sei/Bryde's whale"),
        estimator(spp = c('072', '073', '099', '074'), 
                  title = "Sei/Bryde's/Fin whale",
                  combine_g0 = TRUE))
  
  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Humpback whale {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('076'),
         pool = 'Humpback whale',
         cohort = 'all',
         truncation_distance = 5.5,
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
   estimates <-c(estimator(spp = '076', title = "Humpback whale"))
   
  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Unidentified rorquals {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# UNID rorquals (70)

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('070'),
         pool = 'Unidentified rorqual',
         cohort = 'all',
         truncation_distance = 5.5,
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  estimates <-
      c(estimator(spp = '070', 
                  title = "Unidentified rorqual",
                  alt_g0_spp = c('071','099','074','075'),
                  combine_g0 = TRUE))
  
  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Unidentified dolphins {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# UNID dolphin (177, 277, 377, 77)

if(TRUE){ # toggle

  spp <- c('177','277','377','077')
  pool_title <- 'Unidentified dolphin'

  # Detection function specifications
  fit_filters <-
    list(spp = c('177','277','377','077'),
         pool = pool_title,
         cohort = 'all',
         truncation_distance = 5.5,
         other_species = 'coerce',
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  estimates <- estimator(spp = spp, title = pool_title)
  
  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Unidentified cetaceans {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# UNID cetacean (78, 79, 98, 96)

if(TRUE){ # toggle

  spp <- c('078','079','098','096')
  pool_title <- 'Unidentified cetacean'

  # Detection function specifications
  fit_filters <-
    list(spp = spp,
         pool = pool_title,
         cohort = 'all',
         truncation_distance = 5.5,
         other_species = 'coerce',
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  estimates <- estimator(spp = spp, 
                         title = pool_title, 
                         g0=1.0, 
                         g0_cv = 0.0)

  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Bottlenose dolphin {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# Bottlenose dolphin (018)

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('015', '018', '021', '032'),
         pool = 'Bottlenose dolphin',
         cohort = 'bottlenose',
         truncation_distance = 5,
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  scenarios <- list(
    list(years = 2017,
       regions = 'WHICEAS',
       regions_remove = c('Bottlenose_KaNi', 'Bottlenose_OUFI', 'Bottlenose_BI'),
       region_title = '(WHICEAS)'),
    list(years = 2020,
       regions = 'WHICEAS',
       regions_remove = c('Bottlenose_KaNi', 'Bottlenose_OUFI', 'Bottlenose_BI'),
       region_title = '(WHICEAS)'))
  
  estimator <- lta_estimates(scenarios)
  estimates <- estimator(spp = '018', title = 'Bottlenose dolphin')
  
  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

### Pantropical spotted dolphin {-} 

```{r, echo=TRUE, eval=rerun_from_scratch, collapse=TRUE, message=FALSE, warning=FALSE}
# Pantropical spotted dolphin (002)

if(TRUE){ # toggle

  # Detection function specifications
  fit_filters <-
    list(spp = c('002'),
         pool = 'Pantropical spotted dolphin',
         cohort = 'spotted',
         truncation_distance = 5,
         years = years,
         regions = fit_regions,
         not_regions = fit_not_regions)

  # Density / abundance estimation plan
  scenarios <- list(
    list(years = 2017,
       regions = 'WHICEAS',
       regions_remove = c('Spotted_OU', 'Spotted_FI', 'Spotted_BI'),
       region_title = '(WHICEAS)'),
    list(years = 2020,
       regions = 'WHICEAS',
       regions_remove = c('Spotted_OU', 'Spotted_FI', 'Spotted_BI'),
       region_title = '(WHICEAS)'))
  
  estimator <- lta_estimates(scenarios)
  estimates <- estimator(spp = '002', title = 'Pantropical spotted dolphin')
  
  # Run analysis
  results <- lta(cruz, Rg0, fit_filters, df_settings, estimates,
                 use_g0 = TRUE,
                 bootstraps = bootstraps,
                 toplot=toplot, verbose=verbose)

  # Save result
  (results_file <- paste0(results_path, fit_filters$pool, '.RData'))
  saveRDS(results, file=results_file)
}
```

## Results {-}

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
# Load results
ltas <- lta_enlist('whiceas/lta/')
```

### Tables {-}  

Generate report: 

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti <- lta_report(ltas, cruz)
```

**Table 1a.** *Total and systematic sample sizes.* 

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table1a 
```

```{r, echo=FALSE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table1a %>% 
DT::datatable(extensions = "FixedColumns",
              options=list(scrollX=TRUE,
                           scrollY='450px',
                           paging = FALSE,
                           fixedColumns = list(leftColumns = 2),
                           initComplete = htmlwidgets::JS(
    "function(settings, json) {$(this.api().table().container()).css({'font-size': '9pt'});}")
  ))
```

--- 

**Table 1b.** *Sample sizes of sightings used in density esitmation.*  

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table1b 
```

```{r, echo=FALSE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table1b %>% 
DT::datatable(extensions = "FixedColumns",
              options=list(scrollX=TRUE,
                           scrollY='450px',
                           paging = FALSE,
                           fixedColumns = list(leftColumns = 2),
                           initComplete = htmlwidgets::JS(
    "function(settings, json) {$(this.api().table().container()).css({'font-size': '9pt'});}")
  ))
```

--- 

**Table 2.** *Detection functions for cetacean species and taxonomic categories.*  

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table2 
```

```{r, echo=FALSE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table2 %>% 
DT::datatable(extensions = "FixedColumns",
              options=list(scrollX=TRUE,
                           scrollY='450px',
                           paging = FALSE,
                           fixedColumns = list(leftColumns = 2),
                           initComplete = htmlwidgets::JS(
    "function(settings, json) {$(this.api().table().container()).css({'font-size': '9pt'});}")
  ))
```
  
--- 

**Table 3.** *Estimates of line-transect parameters for cetacean species and taxonomic categories.*  

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table3 
```

```{r, echo=FALSE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table3 %>% 
DT::datatable(extensions = "FixedColumns",
              options=list(scrollX=TRUE,
                           scrollY='450px',
                           paging = FALSE,
                           fixedColumns = list(leftColumns = 2),
                           initComplete = htmlwidgets::JS(
    "function(settings, json) {$(this.api().table().container()).css({'font-size': '9pt'});}")
  ))
```

--- 

**Table 4.** *Estimates of density (individuals per 1,000 km2) and abundance for cetacean species and taxonomic categories sighted while on systematic survey effort.*  

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table4 
```

```{r, echo=FALSE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$table4 %>% 
DT::datatable(extensions = "FixedColumns",
              options=list(scrollX=TRUE,
                           scrollY='450px',
                           paging = FALSE,
                           fixedColumns = list(leftColumns = 2),
                           initComplete = htmlwidgets::JS(
    "function(settings, json) {$(this.api().table().container()).css({'font-size': '9pt'});}")
  ))
```

--- 

**Table A1.** *Study areas*. 

```{r, echo=TRUE, eval=FALSE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$tableA1
```

```{r, echo=FALSE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$tableA1 %>% 
DT::datatable(extensions = "FixedColumns",
              options=list(scrollX=TRUE,
                           paging = FALSE,
                           fixedColumns = list(leftColumns = 1),
                           initComplete = htmlwidgets::JS(
    "function(settings, json) {$(this.api().table().container()).css({'font-size': '9pt'});}")
  ))
```

--- 

**Table A2.** *Effort totals and by Beaufort sea-state, in each survey year*. 

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE}
reporti$tableA2
```


### Plots {-}  

```{r, echo=TRUE, eval=TRUE, collapse=TRUE, message=FALSE, warning=FALSE, fig.width=7, fig.height=21}
lta_plot(species = NULL, 
         lta_result = ltas, 
         years = c(2017, 2020))
```

